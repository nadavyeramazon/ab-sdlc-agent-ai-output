# Docker Compose configuration for Purple Theme Hello World application
# Use 'docker compose up' to start (note: no hyphen in 'docker compose')

# ============================================================================
# IMPORTANT: DOCKER NETWORKING FOR BROWSER-BASED FRONTENDS
# ============================================================================
# This application uses a React frontend that runs IN THE BROWSER.
# The browser makes API calls from the user's machine, NOT from within Docker.
#
# KEY NETWORKING RULES:
# 1. Browser can ONLY access exposed ports via localhost (e.g., localhost:8000)
# 2. Browser CANNOT resolve Docker service names (e.g., 'backend' won't work)
# 3. Docker service names are for container-to-container communication ONLY
#
# CORRECT: Frontend uses VITE_API_URL=http://localhost:8000
#          Browser → localhost:8000 → Docker exposes backend:8000
#
# INCORRECT: Frontend uses VITE_API_URL=http://backend:8000
#            Browser → 'backend' → DNS FAILS (browser can't resolve)
#
# This is why VITE_API_URL must use 'localhost', not 'backend'.
# ============================================================================

version: '3.8'

services:
  # Backend service - FastAPI
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hello-world-backend
    ports:
      # Expose backend port to host machine
      # Format: "host_port:container_port"
      # This makes backend:8000 accessible as localhost:8000 from browser
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ./backend:/app
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Frontend service - React with Vite
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: hello-world-frontend
    ports:
      # Expose frontend port to host machine
      # Format: "host_port:container_port"
      # User accesses app at http://localhost:3000 in their browser
      - "3000:3000"
    environment:
      # CRITICAL: Must use 'localhost' for browser-based frontend!
      # Browser runs on user's machine and accesses exposed Docker ports via localhost.
      # Changing this to 'http://backend:8000' would break the application because
      # browsers cannot resolve Docker service names.
      #
      # How it works:
      # 1. User opens http://localhost:3000 in browser
      # 2. Browser loads React app
      # 3. React app makes fetch() calls to http://localhost:8000/api/*
      # 4. Request goes to host machine's localhost:8000
      # 5. Docker routes localhost:8000 → backend:8000 (container)
      # 6. Backend processes request and returns response
      #
      # Why 'backend:8000' would fail:
      # - Browser tries: fetch('http://backend:8000/api/hello')
      # - Browser's DNS cannot resolve 'backend' hostname
      # - Result: Network error, "Failed to fetch"
      #
      # Service names like 'backend' only work for container-to-container
      # communication (e.g., if one backend service calls another backend service).
      - VITE_API_URL=http://localhost:8000
    volumes:
      - ./frontend:/app
      - /app/node_modules
    networks:
      - app-network
    depends_on:
      - backend
    stdin_open: true
    tty: true

networks:
  app-network:
    driver: bridge

name: CI/CD Pipeline

on:
  push:
    branches: [ feature/JIRA-777/fullstack-app, main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run pytest
      working-directory: ./backend
      run: |
        pytest -v --tb=short
    
    - name: Run pytest with coverage
      working-directory: ./backend
      run: |
        pytest --cov=main --cov-report=term --cov-report=html
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: backend-coverage
        path: backend/htmlcov/

  test-docker-build:
    name: Docker Build Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build backend image
      working-directory: ./backend
      run: |
        docker build -t green-theme-backend:test .
    
    - name: Build frontend image
      working-directory: ./frontend
      run: |
        docker build -t green-theme-frontend:test .
    
    - name: Verify images exist
      run: |
        docker images | grep green-theme

  test-docker-compose:
    name: Docker Compose Integration Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Start services with Docker Compose
      run: |
        docker compose up -d --build
    
    - name: Wait for services to start
      run: |
        echo "Waiting for services to initialize..."
        sleep 15
    
    - name: Check service status
      run: |
        docker compose ps
    
    - name: Test backend health endpoint
      run: |
        curl -f http://localhost:8000/health || exit 1
        HEALTH_RESPONSE=$(curl -s http://localhost:8000/health)
        echo "Health response: $HEALTH_RESPONSE"
        echo $HEALTH_RESPONSE | grep -q '"status":"healthy"' || exit 1
    
    - name: Test backend API endpoint
      run: |
        curl -f http://localhost:8000/api/hello || exit 1
        API_RESPONSE=$(curl -s http://localhost:8000/api/hello)
        echo "API response: $API_RESPONSE"
        echo $API_RESPONSE | grep -q '"message":"Hello World from Backend!"' || exit 1
    
    - name: Validate timestamp format
      run: |
        API_RESPONSE=$(curl -s http://localhost:8000/api/hello)
        TIMESTAMP=$(echo $API_RESPONSE | grep -oP '\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z')
        if [ -z "$TIMESTAMP" ]; then
          echo "ERROR: Timestamp format invalid"
          echo "Response: $API_RESPONSE"
          exit 1
        fi
        echo "Timestamp format valid: $TIMESTAMP"
    
    - name: Test frontend accessibility
      run: |
        FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)
        echo "Frontend status: $FRONTEND_STATUS"
        if [ "$FRONTEND_STATUS" != "200" ]; then
          echo "ERROR: Frontend not accessible"
          exit 1
        fi
    
    - name: Test CORS headers
      run: |
        CORS_RESPONSE=$(curl -s -H "Origin: http://localhost:3000" -v http://localhost:8000/api/hello 2>&1)
        echo "$CORS_RESPONSE" | grep -i "access-control-allow-origin" || exit 1
    
    - name: Show service logs on failure
      if: failure()
      run: |
        echo "=== Backend Logs ==="
        docker compose logs backend
        echo "=== Frontend Logs ==="
        docker compose logs frontend
    
    - name: Stop services
      if: always()
      run: |
        docker compose down -v

  lint-and-format:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black
    
    - name: Run flake8
      working-directory: ./backend
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Check code formatting with black
      working-directory: ./backend
      run: |
        black --check --diff .

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-backend, test-docker-build, test-docker-compose, lint-and-format]
    if: always()
    
    steps:
    - name: Check test results
      run: |
        echo "=== Test Results Summary ==="
        echo "Backend Tests: ${{ needs.test-backend.result }}"
        echo "Docker Build Tests: ${{ needs.test-docker-build.result }}"
        echo "Docker Compose Tests: ${{ needs.test-docker-compose.result }}"
        echo "Code Quality Checks: ${{ needs.lint-and-format.result }}"
        
        if [ "${{ needs.test-backend.result }}" != "success" ] || 
           [ "${{ needs.test-docker-build.result }}" != "success" ] || 
           [ "${{ needs.test-docker-compose.result }}" != "success" ] || 
           [ "${{ needs.lint-and-format.result }}" != "success" ]; then
          echo "❌ Some tests failed"
          exit 1
        fi
        
        echo "✅ All tests passed!"

name: CI/CD Pipeline

# Workflow triggers
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master

# Environment variables shared across jobs
env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: Backend Lint & Test (Combined)
  backend-quality:
    name: Backend Lint & Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        continue-on-error: false
      
      - name: Build images
        run: docker compose build backend mysql
        continue-on-error: false
      
      - name: Start MySQL
        run: docker compose up -d mysql
        continue-on-error: false
      
      - name: Wait for MySQL to be ready
        run: |
          echo "Waiting for MySQL to be ready..."
          timeout 60 bash -c 'until docker compose exec mysql mysqladmin ping -h localhost -u root -prootpassword --silent; do sleep 2; done'
        continue-on-error: false
      
      - name: Lint and test backend
        run: docker compose run --rm backend sh -c "flake8 . && pytest -v --cov=. --cov-report=term-missing"
        continue-on-error: false
      
      - name: Cleanup
        if: always()
        run: docker compose down -v

  # Job 2: Frontend Lint & Test (Combined)
  frontend-quality:
    name: Frontend Lint & Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        continue-on-error: false
      
      - name: Build frontend image
        run: docker compose build frontend
        continue-on-error: false
      
      - name: Lint, test, and build frontend
        run: docker compose run --rm frontend sh -c "npm run lint && npm test && npm run build"
        continue-on-error: false
      
      - name: Cleanup
        if: always()
        run: docker compose down -v

  # Job 3: Docker Compose Integration
  docker-compose-integration:
    name: Docker Compose Integration
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [backend-quality, frontend-quality]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        continue-on-error: false
      
      # Validate docker-compose.yml syntax using V2 syntax
      - name: Validate Docker Compose configuration
        run: docker compose config
        continue-on-error: false
      
      # Start services using Docker Compose V2 syntax
      - name: Start services with Docker Compose
        run: docker compose up -d
        continue-on-error: false
      
      # Wait for services to initialize
      - name: Wait for services to start
        run: sleep 10
      
      # Check if services are running
      - name: Check running services
        run: docker compose ps
      
      # Health check for backend service
      - name: Check backend health
        run: |
          echo "Checking backend health endpoint..."
          curl -f http://localhost:8000/health || exit 1
        continue-on-error: false
      
      # Health check for frontend service
      - name: Check frontend accessibility
        run: |
          echo "Checking frontend accessibility..."
          curl -f http://localhost:3000 || exit 1
        continue-on-error: false
      
      # Show logs for debugging if needed
      - name: Show Docker Compose logs
        if: always()
        run: docker compose logs
      
      # Cleanup - stop and remove containers
      - name: Cleanup Docker Compose
        if: always()
        run: docker compose down -v

  # Job 4: Summary
  ci-success:
    name: CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [backend-quality, frontend-quality, docker-compose-integration]
    if: success()
    
    steps:
      - name: Success message
        run: |
          echo "âœ… All CI pipeline checks passed successfully!"
          echo ""
          echo "Workflow completed:"
          echo "  Stage 1 - Quality checks (parallel):"
          echo "    âœ“ Backend lint & test (docker compose)"
          echo "    âœ“ Frontend lint & test (docker compose)"
          echo ""
          echo "  Stage 2 - Integration:"
          echo "    âœ“ Docker Compose full stack validation"
          echo ""
          echo "All quality gates passed! ðŸŽ‰"
        continue-on-error: false

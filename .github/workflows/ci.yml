name: CI Pipeline - Green Theme Hello World Fullstack

on:
  push:
    branches: [main, develop, 'feature/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# Cancel in-progress runs for same workflow and branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  BACKEND_PORT: 8000
  FRONTEND_PORT: 3000

jobs:
  # Backend Testing Job
  backend-tests:
    name: Backend Tests (Python 3.11 + FastAPI + pytest)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: ğŸ“¦ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ§ª Run Backend Tests with pytest
        run: |
          pytest -v \
            --cov=. \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing:skip-covered \
            --tb=short \
            --junitxml=pytest-report.xml
        env:
          PYTHONPATH: .

      - name: ğŸ“Š Upload Backend Coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: ğŸ“„ Upload Backend Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: |
            backend/htmlcov/
            backend/coverage.xml
            backend/pytest-report.xml
          retention-days: 7

      - name: âœ… Backend Tests Summary
        if: always()
        run: |
          echo "### ğŸ Backend Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f pytest-report.xml ]; then
            echo "âœ… All backend tests completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Backend tests failed" >> $GITHUB_STEP_SUMMARY
          fi

  # Frontend Testing Job
  frontend-tests:
    name: Frontend Tests (Node 18 + React + Vitest)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: ğŸ“¦ Install Frontend Dependencies
        run: npm ci

      - name: ğŸ” Run ESLint
        run: npm run lint
        continue-on-error: false

      - name: ğŸ§ª Run Frontend Tests with Vitest
        run: npm run test:coverage
        env:
          CI: true
          NODE_ENV: test

      - name: ğŸ—ï¸ Build Frontend Application
        run: npm run build

      - name: ğŸ“Š Upload Frontend Coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

      - name: ğŸ“¦ Upload Frontend Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 7

      - name: âœ… Frontend Tests Summary
        if: always()
        run: |
          echo "### âš›ï¸ Frontend Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "dist" ]; then
            echo "âœ… All frontend tests passed and build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Frontend tests or build failed" >> $GITHUB_STEP_SUMMARY
          fi

  # Docker Compose Integration Tests
  integration-tests:
    name: Integration Tests (Docker Compose)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [frontend-tests, backend-tests]

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Docker Images
        run: |
          echo "Building backend image..."
          docker-compose build backend
          echo "Building frontend image..."
          docker-compose build frontend

      - name: ğŸš€ Start Docker Services
        run: |
          docker-compose up -d
          echo "Services started, waiting for health checks..."

      - name: â³ Wait for Backend Service
        run: |
          echo "Waiting for backend on port ${{ env.BACKEND_PORT }}..."
          timeout 60 sh -c 'until curl -f http://localhost:${{ env.BACKEND_PORT }}/health > /dev/null 2>&1; do echo "Waiting..."; sleep 2; done' || (
            echo "Backend failed to start"
            docker-compose logs backend
            exit 1
          )
          echo "âœ… Backend is healthy"

      - name: â³ Wait for Frontend Service
        run: |
          echo "Waiting for frontend on port ${{ env.FRONTEND_PORT }}..."
          timeout 60 sh -c 'until curl -f http://localhost:${{ env.FRONTEND_PORT }} > /dev/null 2>&1; do echo "Waiting..."; sleep 2; done' || (
            echo "Frontend failed to start"
            docker-compose logs frontend
            exit 1
          )
          echo "âœ… Frontend is serving content"

      - name: ğŸ§ª Run Integration Tests
        run: |
          echo "Testing backend health endpoint..."
          curl -f http://localhost:${{ env.BACKEND_PORT }}/health
          
          echo "Testing backend root endpoint..."
          curl -f http://localhost:${{ env.BACKEND_PORT }}/
          
          echo "Testing backend API endpoints..."
          curl -f http://localhost:${{ env.BACKEND_PORT }}/api/hello
          
          echo "Testing frontend is accessible..."
          curl -f http://localhost:${{ env.FRONTEND_PORT }}
          
          echo "âœ… All integration tests passed!"

      - name: ğŸ“‹ Collect Docker Logs on Failure
        if: failure()
        run: |
          echo "=== ğŸ³ Backend Logs ==="
          docker-compose logs backend
          echo ""
          echo "=== âš›ï¸ Frontend Logs ==="
          docker-compose logs frontend

      - name: ğŸ§¹ Cleanup Docker Resources
        if: always()
        run: |
          docker-compose down -v
          docker system prune -f

      - name: âœ… Integration Tests Summary
        if: success()
        run: |
          echo "### ğŸ³ Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All services started successfully" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Backend health check passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Frontend serving content" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All API endpoints responding" >> $GITHUB_STEP_SUMMARY

  # Code Quality and Security Checks
  security-checks:
    name: Security & Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Run in parallel with tests

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”’ Run Trivy Filesystem Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ğŸ“¤ Upload Trivy Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: ğŸ Setup Python for Security Check
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ”’ Check Python Dependencies with Safety
        run: |
          python -m pip install --upgrade pip
          pip install safety
          safety check -r backend/requirements.txt --continue-on-error
        continue-on-error: true

      - name: ğŸ“¦ Setup Node.js for Frontend Security
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”’ Run npm audit
        working-directory: ./frontend
        run: |
          npm audit --audit-level=high --production
        continue-on-error: true

      - name: âœ… Security Checks Summary
        run: |
          echo "### ğŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Trivy vulnerability scan completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Python dependency check completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… npm audit completed" >> $GITHUB_STEP_SUMMARY

  # Final Deployment Readiness Check
  deployment-readiness:
    name: ğŸš€ Deployment Readiness Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [frontend-tests, backend-tests, integration-tests, security-checks]
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download Frontend Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./frontend-build

      - name: âœ… Verify Build Artifacts
        run: |
          echo "Verifying frontend build artifacts..."
          ls -la ./frontend-build
          
          # Check if essential files exist
          if [ ! -f ./frontend-build/index.html ]; then
            echo "âŒ Missing index.html in build"
            exit 1
          fi
          
          echo "âœ… Build artifacts verified successfully!"

      - name: ğŸ“Š Generate Deployment Summary
        run: |
          echo "## ğŸš€ Green Theme Hello World - Deployment Readiness" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… All CI Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ Backend Tests | âœ… Passed | Python 3.11 + FastAPI + pytest |" >> $GITHUB_STEP_SUMMARY
          echo "| âš›ï¸ Frontend Tests | âœ… Passed | Node 18 + React + Vitest |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ³ Integration | âœ… Passed | Docker Compose + Health Checks |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”’ Security | âœ… Passed | Trivy + Safety + npm audit |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ—ï¸ Build | âœ… Success | Production artifacts ready |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ‰ Ready for Deployment!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All tests passed and the Green Theme Hello World Fullstack Application is ready to deploy." >> $GITHUB_STEP_SUMMARY

  # Notification Job (optional, runs on main branch)
  notify-success:
    name: âœ… Success Notification
    runs-on: ubuntu-latest
    needs: [deployment-readiness]
    if: success() && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ‰ Workflow Success
        run: |
          echo "âœ… CI Pipeline completed successfully!"
          echo "ğŸ¨ Green Theme Hello World Fullstack Application"
          echo "ğŸ“¦ Branch: ${{ github.ref_name }}"
          echo "ğŸ”– Commit: ${{ github.sha }}"
          echo "ğŸš€ All tests passed - Ready for deployment!"

  notify-failure:
    name: âŒ Failure Notification
    runs-on: ubuntu-latest
    needs: [deployment-readiness]
    if: failure()

    steps:
      - name: âŒ Workflow Failed
        run: |
          echo "âŒ CI Pipeline failed!"
          echo "ğŸ¨ Green Theme Hello World Fullstack Application"
          echo "ğŸ“¦ Branch: ${{ github.ref_name }}"
          echo "ğŸ”– Commit: ${{ github.sha }}"
          echo "âš ï¸ Please check the failed jobs and fix the issues."
          exit 1

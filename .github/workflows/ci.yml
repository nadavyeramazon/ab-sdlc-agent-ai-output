name: CI Pipeline

on:
  push:
    branches: [ "feature/JIRA-777/fullstack-app", "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
    
    - name: Run pytest tests
      run: |
        cd backend
        pytest ../tests/ -v --tb=short
    
    - name: Test coverage report
      run: |
        cd backend
        pytest ../tests/ --cov=. --cov-report=term-missing || true

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: ./frontend
      run: npm run build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: frontend-build
        path: frontend/dist/

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [test-backend, build-frontend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build backend image
      run: |
        docker build -t purple-backend:test ./backend
    
    - name: Build frontend image
      run: |
        docker build -t purple-frontend:test ./frontend
    
    - name: Test docker-compose configuration
      run: |
        docker compose config

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [docker-build]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Start services with docker-compose
      run: |
        docker compose up -d
    
    - name: Wait for services to be healthy
      run: |
        echo "Waiting for backend to be healthy..."
        timeout 60 sh -c 'until curl -f http://localhost:8000/health; do sleep 2; done'
        echo "Backend is healthy!"
    
    - name: Test backend endpoints
      run: |
        echo "Testing /health endpoint..."
        curl -f http://localhost:8000/health
        
        echo "Testing /api/hello endpoint..."
        curl -f http://localhost:8000/api/hello
        
        echo "Testing /api/greet endpoint..."
        curl -f -X POST http://localhost:8000/api/greet \
          -H "Content-Type: application/json" \
          -d '{"name": "CI Test"}'
    
    - name: Check frontend accessibility
      run: |
        echo "Checking frontend is accessible..."
        timeout 30 sh -c 'until curl -f http://localhost:3000; do sleep 2; done'
        echo "Frontend is accessible!"
    
    - name: Show service logs on failure
      if: failure()
      run: |
        echo "=== Backend logs ==="
        docker compose logs backend
        echo "=== Frontend logs ==="
        docker compose logs frontend
    
    - name: Stop services
      if: always()
      run: |
        docker compose down -v
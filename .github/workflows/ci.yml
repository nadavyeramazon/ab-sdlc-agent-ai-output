name: CI/CD Pipeline

# Workflow triggers - runs on pull requests and pushes to main/master
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - master

# Environment variables shared across jobs
env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: Backend Tests
  # Validates Python backend code, runs tests, and checks code quality
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      # Cache pip dependencies for faster subsequent runs
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify backend imports
        working-directory: ./backend
        run: |
          python -c "from main import app; print('âœ“ Backend imports successfully')"
      
      - name: Run code formatting checks
        working-directory: ./backend
        run: |
          echo "Running Black formatter check..."
          black --check . || echo "::warning::Black formatting issues found"
          echo "Running isort import check..."
          isort --check-only . || echo "::warning::Import ordering issues found"
      
      - name: Run linting checks
        working-directory: ./backend
        run: |
          echo "Running flake8 linting..."
          flake8 .
      
      # CRITICAL: Run tests, NOT server commands (uvicorn, python main.py)
      - name: Run backend tests with pytest
        working-directory: ./backend
        run: |
          echo "Running pytest test suite..."
          pytest tests/ -v --tb=short
      
      - name: Run tests with coverage
        working-directory: ./backend
        run: |
          echo "Running tests with coverage reporting..."
          pytest tests/ --cov=. --cov-report=term --cov-report=xml
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./backend/coverage.xml
          flags: backend
          name: backend-coverage
        continue-on-error: true

  # Job 2: Frontend Tests
  # Validates React frontend code, runs tests, and checks code quality
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # Cache npm dependencies for faster subsequent runs
      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      # CRITICAL: Use 'npm install' NOT 'npm ci'
      - name: Install dependencies
        working-directory: ./frontend
        run: npm install
      
      - name: Run ESLint
        working-directory: ./frontend
        run: |
          echo "Running ESLint..."
          npm run lint
      
      - name: Run Prettier format check
        working-directory: ./frontend
        run: |
          echo "Running Prettier format check..."
          npm run format:check
      
      # CRITICAL: Run 'npm test' NOT 'npm run dev' or 'npm start'
      # Dev servers will hang CI and cause workflow failures
      - name: Run frontend tests with Vitest
        working-directory: ./frontend
        run: |
          echo "Running Vitest test suite..."
          npm test
      
      - name: Run tests with coverage
        working-directory: ./frontend
        run: |
          echo "Running tests with coverage reporting..."
          npm run test:coverage
        continue-on-error: true
      
      - name: Build frontend application
        working-directory: ./frontend
        run: |
          echo "Building frontend for production..."
          npm run build
      
      - name: Verify build output
        working-directory: ./frontend
        run: |
          echo "Verifying build artifacts..."
          ls -lah dist/

  # Job 3: Docker Build Verification
  # Validates that Docker images can be built successfully
  docker-build:
    name: Docker Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build backend Docker image
        run: |
          echo "Building backend Docker image..."
          docker build -t task-manager-backend:${{ github.sha }} ./backend
          echo "âœ“ Backend image built successfully"
      
      - name: Build frontend Docker image
        run: |
          echo "Building frontend Docker image..."
          docker build -t task-manager-frontend:${{ github.sha }} ./frontend
          echo "âœ“ Frontend image built successfully"
      
      - name: List built images
        run: |
          echo "Built Docker images:"
          docker images | grep task-manager
      
      - name: Inspect backend image
        run: |
          echo "Backend image details:"
          docker inspect task-manager-backend:${{ github.sha }} --format='{{.Size}}' | awk '{print "Size: " $1/1024/1024 " MB"}'
      
      - name: Inspect frontend image
        run: |
          echo "Frontend image details:"
          docker inspect task-manager-frontend:${{ github.sha }} --format='{{.Size}}' | awk '{print "Size: " $1/1024/1024 " MB"}'

  # Job 4: Docker Compose Validation
  # Validates docker-compose.yml and tests multi-service startup
  docker-compose-validation:
    name: Docker Compose Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [backend-tests, frontend-tests, docker-build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      # CRITICAL: Use Docker Compose V2 syntax (docker compose with space)
      - name: Validate Docker Compose configuration
        run: |
          echo "Validating docker-compose.yml syntax..."
          docker compose config
          echo "âœ“ Docker Compose configuration is valid"
      
      - name: Start services with Docker Compose
        run: |
          echo "Starting services with Docker Compose..."
          docker compose up -d
          echo "âœ“ Services started successfully"
      
      - name: Wait for services to initialize
        run: |
          echo "Waiting for services to start..."
          sleep 15
      
      - name: Check running services
        run: |
          echo "Checking service status..."
          docker compose ps
      
      - name: Check backend container logs
        run: |
          echo "Backend container logs:"
          docker compose logs backend | tail -n 20
      
      - name: Check frontend container logs
        run: |
          echo "Frontend container logs:"
          docker compose logs frontend | tail -n 20
      
      - name: Test backend health endpoint
        run: |
          echo "Testing backend health endpoint..."
          for i in {1..10}; do
            if curl -f http://localhost:8000/health 2>/dev/null; then
              echo "âœ“ Backend health check passed"
              exit 0
            fi
            echo "Attempt $i: Backend not ready yet, waiting..."
            sleep 3
          done
          echo "âŒ Backend health check failed"
          docker compose logs backend
          exit 1
      
      - name: Test frontend accessibility
        run: |
          echo "Testing frontend accessibility..."
          for i in {1..10}; do
            if curl -f http://localhost:3000 2>/dev/null; then
              echo "âœ“ Frontend accessibility check passed"
              exit 0
            fi
            echo "Attempt $i: Frontend not ready yet, waiting..."
            sleep 3
          done
          echo "âŒ Frontend accessibility check failed"
          docker compose logs frontend
          exit 1
      
      - name: Test backend API endpoints
        run: |
          echo "Testing backend API endpoints..."
          # Test root endpoint
          curl -f http://localhost:8000/ || exit 1
          # Test tasks endpoint
          curl -f http://localhost:8000/tasks || exit 1
          echo "âœ“ Backend API endpoints responding"
      
      - name: Show complete logs on failure
        if: failure()
        run: |
          echo "=== Complete Docker Compose Logs ==="
          docker compose logs
      
      - name: Cleanup Docker Compose
        if: always()
        run: |
          echo "Stopping and removing containers..."
          docker compose down -v
          echo "âœ“ Cleanup completed"

  # Summary job - provides overall pipeline status
  ci-success:
    name: CI Pipeline Complete
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, docker-build, docker-compose-validation]
    if: success()
    
    steps:
      - name: Pipeline success summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… CI/CD Pipeline Completed Successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ“ Backend Tests:            PASSED"
          echo "âœ“ Frontend Tests:           PASSED"
          echo "âœ“ Docker Build:             PASSED"
          echo "âœ“ Docker Compose Validation: PASSED"
          echo ""
          echo "All checks have passed. Ready to merge! ğŸš€"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

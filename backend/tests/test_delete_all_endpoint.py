"""\nComprehensive tests for DELETE /api/tasks endpoint (delete all tasks).\n\nThis test suite covers:\n- Successful deletion of all tasks\n- Behavior when no tasks exist\n- Database state after deletion\n- Error scenarios and edge cases\n- Idempotency\n- Integration with other endpoints\n"""\n\nimport pytest\nfrom fastapi.testclient import TestClient\nfrom hypothesis import given, settings, strategies as st\nfrom hypothesis import HealthCheck\nfrom main import app\n\n\n@pytest.fixture\ndef client():\n    \"\"\"\n    Create a TestClient instance for testing FastAPI endpoints.\n    This fixture is reused across all tests.\n    \"\"\"\n    import tempfile\n    import os\n    from task_repository import TaskRepository\n    \n    # Create a temporary directory for test data\n    temp_dir = tempfile.mkdtemp()\n    test_data_file = os.path.join(temp_dir, \"test_tasks.json\")\n    \n    # Override the repository with test data file\n    import main\n    main._task_repository = TaskRepository(data_file=test_data_file)\n    \n    client = TestClient(app)\n    \n    yield client\n    \n    # Cleanup\n    import shutil\n    shutil.rmtree(temp_dir, ignore_errors=True)\n    main._task_repository = None\n\n\nclass TestDeleteAllTasksEndpoint:\n    \"\"\"\n    Comprehensive tests for DELETE /api/tasks endpoint.\n    \n    **Feature: task-manager-app, Delete All Tasks**\n    **Validates: Bulk deletion of all tasks via REST API**\n    \"\"\"\n    \n    def test_delete_all_tasks_success(self, client):\n        \"\"\"\n        Test successful deletion of all tasks.\n        \n        Verifies:\n        - Returns 204 No Content status\n        - All tasks are deleted\n        - GET /api/tasks returns empty list after deletion\n        \"\"\"\n        # Clear existing tasks first\n        existing_response = client.get(\"/api/tasks\")\n        for task in existing_response.json()[\"tasks\"]:\n            client.delete(f\"/api/tasks/{task['id']}\")\n        \n        # Create multiple tasks\n        client.post(\"/api/tasks\", json={\"title\": \"Task 1\", \"description\": \"Desc 1\"})\n        client.post(\"/api/tasks\", json={\"title\": \"Task 2\", \"description\": \"Desc 2\"})\n        client.post(\"/api/tasks\", json={\"title\": \"Task 3\", \"description\": \"Desc 3\"})\n        \n        # Verify tasks exist\n        before_response = client.get(\"/api/tasks\")\n        assert before_response.status_code == 200\n        assert len(before_response.json()[\"tasks\"]) == 3\n        \n        # Delete all tasks\n        delete_response = client.delete(\"/api/tasks\")\n        \n        # Verify status code\n        assert delete_response.status_code == 204\n        \n        # Verify response has no content\n        assert delete_response.content == b\"\"\n        \n        # Verify all tasks are deleted\n        after_response = client.get(\"/api/tasks\")\n        assert after_response.status_code == 200\n        tasks = after_response.json()[\"tasks\"]\n        assert len(tasks) == 0\n        assert tasks == []\n    \n    def test_delete_all_tasks_empty_repository(self, client):\n        \"\"\"\n        Test delete_all when no tasks exist.\n        \n        Verifies:\n        - Returns 204 No Content status\n        - Does not cause errors\n        - Repository remains in valid state\n        \"\"\"\n        # Clear all existing tasks\n        existing_response = client.get(\"/api/tasks\")\n        for task in existing_response.json()[\"tasks\"]:\n            client.delete(f\"/api/tasks/{task['id']}\")\n        \n        # Verify repository is empty\n        before_response = client.get(\"/api/tasks\")\n        assert len(before_response.json()[\"tasks\"]) == 0\n        \n        # Delete all tasks (none exist)\n        delete_response = client.delete(\"/api/tasks\")\n        \n        # Verify status code\n        assert delete_response.status_code == 204\n        \n        # Verify repository is still empty\n        after_response = client.get(\"/api/tasks\")\n        assert after_response.status_code == 200\n        assert len(after_response.json()[\"tasks\"]) == 0\n    \n    def test_delete_all_tasks_idempotence(self, client):\n        \"\"\"\n        Test that calling delete_all multiple times is safe (idempotent).\n        \n        Verifies:\n        - Multiple calls return 204\n        - No errors occur\n        - Repository remains empty after each call\n        \"\"\"\n        # Clear existing tasks first\n        existing_response = client.get(\"/api/tasks\")\n        for task in existing_response.json()[\"tasks\"]:\n            client.delete(f\"/api/tasks/{task['id']}\")\n        \n        # Create tasks\n        client.post(\"/api/tasks\", json={\"title\": \"Task 1\", \"description\": \"Desc 1\"})\n        client.post(\"/api/tasks\", json={\"title\": \"Task 2\", \"description\": \"Desc 2\"})\n        \n        # First delete_all\n        delete_response1 = client.delete(\"/api/tasks\")\n        assert delete_response1.status_code == 204\n        assert len(client.get(\"/api/tasks\").json()[\"tasks\"]) == 0\n        \n        # Second delete_all (should be safe)\n        delete_response2 = client.delete(\"/api/tasks\")\n        assert delete_response2.status_code == 204\n        assert len(client.get(\"/api/tasks\").json()[\"tasks\"]) == 0\n        \n        # Third delete_all (should still be safe)\n        delete_response3 = client.delete(\"/api/tasks\")\n        assert delete_response3.status_code == 204\n        assert len(client.get(\"/api/tasks\").json()[\"tasks\"]) == 0\n    \n    def test_delete_all_tasks_specific_tasks_not_retrievable(self, client):\n        \"\"\"\n        Test that specific tasks cannot be retrieved after delete_all.\n        \n        Verifies:\n        - Individual task IDs return 404 after delete_all\n        - All tasks are truly deleted, not just hidden\n        \"\"\"\n        # Clear existing tasks first\n        existing_response = client.get(\"/api/tasks\")\n        for task in existing_response.json()[\"tasks\"]:\n            client.delete(f\"/api/tasks/{task['id']}\")\n        \n        # Create tasks and store their IDs\n        response1 = client.post(\"/api/tasks\", json={\"title\": \"Task 1\", \"description\": \"Desc 1\"})\n        task1_id = response1.json()[\"id\"]\n        \n        response2 = client.post(\"/api/tasks\", json={\"title\": \"Task 2\", \"description\": \"Desc 2\"})\n        task2_id = response2.json()[\"id\"]\n        \n        response3 = client.post(\"/api/tasks\", json={\"title\": \"Task 3\", \"description\": \"Desc 3\"})\n        task3_id = response3.json()[\"id\"]\n        \n        # Verify tasks can be retrieved before deletion\n        assert client.get(f\"/api/tasks/{task1_id}\").status_code == 200\n        assert client.get(f\"/api/tasks/{task2_id}\").status_code == 200\n        assert client.get(f\"/api/tasks/{task3_id}\").status_code == 200\n        \n        # Delete all tasks\n        delete_response = client.delete(\"/api/tasks\")\n        assert delete_response.status_code == 204\n        \n        # Verify tasks cannot be retrieved after deletion\n        assert client.get(f\"/api/tasks/{task1_id}\").status_code == 404\n        assert client.get(f\"/api/tasks/{task2_id}\").status_code == 404\n        assert client.get(f\"/api/tasks/{task3_id}\").status_code == 404\n    \n    def test_delete_all_tasks_allows_new_tasks_after_deletion(self, client):\n        \"\"\"\n        Test that new tasks can be created after delete_all.\n        \n        Verifies:\n        - API remains functional after delete_all\n        - New tasks can be created with fresh IDs\n        - New tasks are properly stored and retrievable\n        \"\"\"\n        # Clear existing tasks first\n        existing_response = client.get(\"/api/tasks\")\n        for task in existing_response.json()[\"tasks\"]:\n            client.delete(f\"/api/tasks/{task['id']}\")\n        \n        # Create initial tasks\n        client.post(\"/api/tasks\", json={\"title\": \"Task 1\", \"description\": \"Desc 1\"})\n        client.post(\"/api/tasks\", json={\"title\": \"Task 2\", \"description\": \"Desc 2\"})\n        \n        # Delete all tasks\n        delete_response = client.delete(\"/api/tasks\")\n        assert delete_response.status_code == 204\n        \n        # Create new tasks after deletion\n        new_response1 = client.post(\"/api/tasks\", json={\"title\": \"New Task 1\", \"description\": \"New Desc 1\"})\n        new_response2 = client.post(\"/api/tasks\", json={\"title\": \"New Task 2\", \"description\": \"New Desc 2\"})\n        \n        # Verify new tasks were created\n        assert new_response1.status_code == 201\n        assert new_response2.status_code == 201\n        \n        # Verify new tasks exist\n        tasks_response = client.get(\"/api/tasks\")\n        tasks = tasks_response.json()[\"tasks\"]\n        assert len(tasks) == 2\n        assert tasks[0][\"title\"] in [\"New Task 1\", \"New Task 2\"]\n        assert tasks[1][\"title\"] in [\"New Task 1\", \"New Task 2\"]\n    \n    def test_delete_all_tasks_with_mixed_states(self, client):\n        \"\"\"\n        Test delete_all removes tasks regardless of completion state.\n        \n        Verifies:\n        - Both completed and incomplete tasks are deleted\n        - Task state doesn't affect deletion\n        \"\"\"\n        # Clear existing tasks first\n        existing_response = client.get(\"/api/tasks\")\n        for task in existing_response.json()[\"tasks\"]:\n            client.delete(f\"/api/tasks/{task['id']}\")\n        \n        # Create incomplete task\n        incomplete_response = client.post(\"/api/tasks\", json={\"title\": \"Incomplete Task\", \"description\": \"Not done\"})\n        incomplete_id = incomplete_response.json()[\"id\"]\n        \n        # Create completed task\n        complete_response = client.post(\"/api/tasks\", json={\"title\": \"Complete Task\", \"description\": \"Done\"})\n        complete_id = complete_response.json()[\"id\"]\n        client.put(f\"/api/tasks/{complete_id}\", json={\"completed\": True})\n        \n        # Verify both tasks exist\n        assert len(client.get(\"/api/tasks\").json()[\"tasks\"]) == 2\n        \n        # Delete all tasks\n        delete_response = client.delete(\"/api/tasks\")\n        assert delete_response.status_code == 204\n        \n        # Verify both tasks are deleted\n        assert len(client.get(\"/api/tasks\").json()[\"tasks\"]) == 0\n        assert client.get(f\"/api/tasks/{incomplete_id}\").status_code == 404\n        assert client.get(f\"/api/tasks/{complete_id}\").status_code == 404\n    \n    def test_delete_all_tasks_wrong_http_methods(self, client):\n        \"\"\"\n        Test that other HTTP methods are not allowed on /api/tasks (without ID).\n        \n        Verifies:\n        - PUT is not allowed (405)\n        - PATCH is not allowed (405)\n        - GET and POST are allowed (separate endpoint functionality)\n        \"\"\"\n        # Test PUT is not allowed\n        put_response = client.put(\"/api/tasks\", json={\"title\": \"Test\"})\n        assert put_response.status_code == 405\n        \n        # Test PATCH is not allowed\n        patch_response = client.patch(\"/api/tasks\", json={\"title\": \"Test\"})\n        assert patch_response.status_code == 405\n        \n        # Verify GET still works (different endpoint)\n        get_response = client.get(\"/api/tasks\")\n        assert get_response.status_code == 200\n        \n        # Verify POST still works (different endpoint)\n        post_response = client.post(\"/api/tasks\", json={\"title\": \"Test Task\", \"description\": \"Test\"})\n        assert post_response.status_code == 201\n    \n    def test_delete_all_tasks_no_trailing_slash(self, client):\n        \"\"\"\n        Test that /api/tasks/ (with trailing slash) is not the same endpoint.\n        \n        Verifies:\n        - Trailing slash returns 404 (redirect_slashes is disabled)\n        - Endpoint is strict about path matching\n        \"\"\"\n        # Clear existing tasks first\n        existing_response = client.get(\"/api/tasks\")\n        for task in existing_response.json()[\"tasks\"]:\n            client.delete(f\"/api/tasks/{task['id']}\")\n        \n        # Create a task\n        client.post(\"/api/tasks\", json={\"title\": \"Task 1\", \"description\": \"Desc 1\"})\n        \n        # Try to delete with trailing slash\n        delete_response = client.delete(\"/api/tasks/\")\n        \n        # Should return 404 (redirect_slashes is disabled)\n        assert delete_response.status_code == 404\n        \n        # Verify task still exists\n        tasks = client.get(\"/api/tasks\").json()[\"tasks\"]\n        assert len(tasks) == 1\n    \n    def test_delete_all_tasks_response_headers(self, client):\n        \"\"\"\n        Test that delete_all returns appropriate response headers.\n        \n        Verifies:\n        - CORS headers are present (if configured)\n        - Content-Length is 0 or not present\n        - No body is returned\n        \"\"\"\n        # Clear existing tasks first\n        existing_response = client.get(\"/api/tasks\")\n        for task in existing_response.json()[\"tasks\"]:\n            client.delete(f\"/api/tasks/{task['id']}\")\n        \n        # Create tasks\n        client.post(\"/api/tasks\", json={\"title\": \"Task 1\", \"description\": \"Desc 1\"})\n        \n        # Delete all tasks\n        delete_response = client.delete(\"/api/tasks\")\n        \n        # Verify status code\n        assert delete_response.status_code == 204\n        \n        # Verify no content is returned\n        assert delete_response.content == b\"\"\n        \n        # Verify content-length is 0 or not set\n        content_length = delete_response.headers.get(\"content-length\")\n        if content_length is not None:\n            assert int(content_length) == 0\n    \n    @given(st.lists(\n        st.tuples(\n            st.text(min_size=1, max_size=200).filter(lambda s: s.strip()),  # title\n            st.text(max_size=1000)  # description\n        ),\n        min_size=1,\n        max_size=20\n    ))\n    @settings(max_examples=50, suppress_health_check=[HealthCheck.function_scoped_fixture])\n    def test_property_delete_all_removes_all_tasks_comprehensive(self, client, task_data_list):\n        \"\"\"\n        Property-based test: DELETE /api/tasks removes all tasks regardless of quantity.\n        \n        For any non-empty set of tasks, delete_all should remove all tasks\n        and return 204 status.\n        \n        **Feature: task-manager-app, Property: Delete all completeness via API**\n        \"\"\"\n        # Clear existing tasks first\n        existing_response = client.get(\"/api/tasks\")\n        for task in existing_response.json()[\"tasks\"]:\n            client.delete(f\"/api/tasks/{task['id']}\")\n        \n        # Create all tasks\n        created_count = 0\n        for title, description in task_data_list:\n            response = client.post(\"/api/tasks\", json={\n                \"title\": title.strip(),\n                \"description\": description\n            })\n            if response.status_code == 201:\n                created_count += 1\n        \n        # Verify tasks were created\n        tasks_before = client.get(\"/api/tasks\").json()[\"tasks\"]\n        assert len(tasks_before) == created_count\n        \n        # Delete all tasks\n        delete_response = client.delete(\"/api/tasks\")\n        \n        # Verify deletion succeeded\n        assert delete_response.status_code == 204\n        \n        # Verify all tasks are deleted\n        tasks_after = client.get(\"/api/tasks\").json()[\"tasks\"]\n        assert len(tasks_after) == 0\n    \n    def test_delete_all_tasks_persistence(self, client):\n        \"\"\"\n        Test that delete_all persists deletion to storage.\n        \n        Verifies:\n        - Deletion is written to persistent storage\n        - Repository reload shows empty state\n        - New repository instance has no tasks\n        \"\"\"\n        import tempfile\n        import os\n        from task_repository import TaskRepository\n        \n        # Create a new temp file for this specific test\n        temp_dir = tempfile.mkdtemp()\n        test_data_file = os.path.join(temp_dir, \"persistence_test.json\")\n        \n        try:\n            # Create repository with test file\n            import main\n            original_repo = main._task_repository\n            main._task_repository = TaskRepository(data_file=test_data_file)\n            \n            # Use new test client with this repository\n            test_client = TestClient(app)\n            \n            # Create tasks\n            test_client.post(\"/api/tasks\", json={\"title\": \"Task 1\", \"description\": \"Desc 1\"})\n            test_client.post(\"/api/tasks\", json={\"title\": \"Task 2\", \"description\": \"Desc 2\"})\n            \n            # Delete all tasks\n            delete_response = test_client.delete(\"/api/tasks\")\n            assert delete_response.status_code == 204\n            \n            # Create new repository instance (simulates app restart)\n            main._task_repository = TaskRepository(data_file=test_data_file)\n            test_client = TestClient(app)\n            \n            # Verify tasks are still deleted after \"restart\"\n            tasks = test_client.get(\"/api/tasks\").json()[\"tasks\"]\n            assert len(tasks) == 0\n            \n            # Restore original repository\n            main._task_repository = original_repo\n            \n        finally:\n            import shutil\n            shutil.rmtree(temp_dir, ignore_errors=True)\n    \n    def test_delete_all_tasks_concurrent_operations(self, client):\n        \"\"\"\n        Test delete_all behavior with rapid successive calls.\n        \n        Verifies:\n        - Multiple rapid calls don't cause errors\n        - Final state is consistent (empty)\n        - No race conditions or data corruption\n        \"\"\"\n        # Clear existing tasks first\n        existing_response = client.get(\"/api/tasks\")\n        for task in existing_response.json()[\"tasks\"]:\n            client.delete(f\"/api/tasks/{task['id']}\")\n        \n        # Create multiple tasks\n        for i in range(10):\n            client.post(\"/api/tasks\", json={\"title\": f\"Task {i}\", \"description\": f\"Desc {i}\"})\n        \n        # Make multiple rapid delete_all calls\n        responses = []\n        for _ in range(5):\n            response = client.delete(\"/api/tasks\")\n            responses.append(response)\n        \n        # Verify all responses are 204\n        for response in responses:\n            assert response.status_code == 204\n        \n        # Verify final state is empty\n        final_tasks = client.get(\"/api/tasks\").json()[\"tasks\"]\n        assert len(final_tasks) == 0\n    \n    def test_delete_all_tasks_integration_with_other_endpoints(self, client):\n        \"\"\"\n        Test delete_all integration with other task endpoints.\n        \n        Verifies:\n        - Individual task operations work before delete_all\n        - Individual task operations work after delete_all\n        - All endpoints remain functional\n        \"\"\"\n        # Clear existing tasks first\n        existing_response = client.get(\"/api/tasks\")\n        for task in existing_response.json()[\"tasks\"]:\n            client.delete(f\"/api/tasks/{task['id']}\")\n        \n        # Create a task\n        create_response = client.post(\"/api/tasks\", json={\"title\": \"Task 1\", \"description\": \"Desc 1\"})\n        task_id = create_response.json()[\"id\"]\n        \n        # Update the task\n        update_response = client.put(f\"/api/tasks/{task_id}\", json={\"title\": \"Updated Task 1\"})\n        assert update_response.status_code == 200\n        \n        # Get the task\n        get_response = client.get(f\"/api/tasks/{task_id}\")\n        assert get_response.status_code == 200\n        \n        # Delete all tasks\n        delete_all_response = client.delete(\"/api/tasks\")\n        assert delete_all_response.status_code == 204\n        \n        # Verify task is gone\n        get_after_response = client.get(f\"/api/tasks/{task_id}\")\n        assert get_after_response.status_code == 404\n        \n        # Create new task after delete_all\n        new_create_response = client.post(\"/api/tasks\", json={\"title\": \"New Task\", \"description\": \"New Desc\"})\n        assert new_create_response.status_code == 201\n        new_task_id = new_create_response.json()[\"id\"]\n        \n        # Verify new task exists\n        new_get_response = client.get(f\"/api/tasks/{new_task_id}\")\n        assert new_get_response.status_code == 200\n
"""\nProperty-based tests for TaskRepository.\n\nThis test suite uses Hypothesis for property-based testing to verify\ncorrectness properties of the task repository implementation.\n"""\n\nimport pytest\nimport tempfile\nimport os\nfrom hypothesis import given, settings, strategies as st\nfrom task_repository import TaskRepository\nfrom main import TaskCreate, TaskUpdate\n\n\n# Custom strategies for generating test data\n@st.composite\ndef task_create_strategy(draw):\n    """\n    Generate valid TaskCreate objects for property testing.\n    \n    Generates titles that are non-empty and within length limits,\n    and descriptions within length limits.\n    """\n    # Generate non-empty title (1-200 chars)\n    title = draw(st.text(min_size=1, max_size=200).filter(lambda s: s.strip() != ""))\n    # Generate description (0-1000 chars)\n    description = draw(st.text(min_size=0, max_size=1000))\n    \n    return TaskCreate(title=title, description=description)\n\n\n@pytest.fixture\ndef temp_repo():\n    """\n    Create a temporary TaskRepository for testing.\n    Uses a temporary file that is cleaned up after the test.\n    """\n    with tempfile.NamedTemporaryFile(mode='w', delete=False, suffix='.json') as f:\n        temp_file = f.name\n    \n    try:\n        repo = TaskRepository(data_file=temp_file)\n        yield repo\n    finally:\n        # Clean up\n        if os.path.exists(temp_file):\n            os.remove(temp_file)\n\n\nclass TestTaskCreationPersistence:\n    """\n    Property-based tests for task creation and persistence.\n    \n    **Feature: task-manager-app, Property 1: Task creation persistence**\n    **Validates: Requirements 1.1, 1.4**\n    """\n    \n    @settings(max_examples=100)\n    @given(task_data=task_create_strategy())\n    def test_created_task_appears_in_get_all(self, task_data):\n        """\n        Property: For any valid task with a non-empty title, when the task is \n        created through the repository, retrieving all tasks should include the \n        newly created task with matching title and description.\n        \n        **Feature: task-manager-app, Property 1: Task creation persistence**\n        **Validates: Requirements 1.1, 1.4**\n        """\n        # Create a temporary repository for this test\n        with tempfile.NamedTemporaryFile(mode='w', delete=False, suffix='.json') as f:\n            temp_file = f.name\n        \n        try:\n            repo = TaskRepository(data_file=temp_file)\n            \n            # Create the task\n            created_task = repo.create(task_data)\n            \n            # Retrieve all tasks\n            all_tasks = repo.get_all()\n            \n            # Verify the created task appears in the list\n            assert len(all_tasks) == 1\n            assert all_tasks[0].id == created_task.id\n            assert all_tasks[0].title == task_data.title\n            assert all_tasks[0].description == task_data.description\n            assert all_tasks[0].completed == False\n            \n        finally:\n            if os.path.exists(temp_file):\n                os.remove(temp_file)\n\n\nclass TestPersistenceAcrossRestarts:\n    """\n    Property-based tests for persistence across repository restarts.\n    \n    **Feature: task-manager-app, Property 9: Persistence across restarts**\n    **Validates: Requirements 7.1, 7.3**\n    """\n    \n    @settings(max_examples=100)\n    @given(tasks_data=st.lists(task_create_strategy(), min_size=1, max_size=10))\n    def test_tasks_persist_across_restarts(self, tasks_data):\n        """\n        Property: For any set of tasks created before a repository restart, \n        when the repository restarts and loads data, all previously created \n        tasks should be retrievable with identical data (id, title, description, \n        completed status, timestamps).\n        \n        **Feature: task-manager-app, Property 9: Persistence across restarts**\n        **Validates: Requirements 7.1, 7.3**\n        """\n        # Create a temporary file for persistence\n        with tempfile.NamedTemporaryFile(mode='w', delete=False, suffix='.json') as f:\n            temp_file = f.name\n        \n        try:\n            # Create first repository instance and add tasks\n            repo1 = TaskRepository(data_file=temp_file)\n            created_tasks = []\n            for task_data in tasks_data:\n                task = repo1.create(task_data)\n                created_tasks.append(task)\n            \n            # Store task details for comparison\n            task_details = [\n                {\n                    'id': t.id,\n                    'title': t.title,\n                    'description': t.description,\n                    'completed': t.completed,\n                    'created_at': t.created_at,\n                    'updated_at': t.updated_at\n                }\n                for t in created_tasks\n            ]\n            \n            # Simulate restart by creating a new repository instance\n            repo2 = TaskRepository(data_file=temp_file)\n            \n            # Retrieve all tasks from the new instance\n            loaded_tasks = repo2.get_all()\n            \n            # Verify all tasks were loaded\n            assert len(loaded_tasks) == len(created_tasks)\n            \n            # Verify each task's data is identical\n            loaded_tasks_by_id = {t.id: t for t in loaded_tasks}\n            for expected in task_details:\n                loaded = loaded_tasks_by_id[expected['id']]\n                assert loaded.id == expected['id']\n                assert loaded.title == expected['title']\n                assert loaded.description == expected['description']\n                assert loaded.completed == expected['completed']\n                assert loaded.created_at == expected['created_at']\n                assert loaded.updated_at == expected['updated_at']\n                \n        finally:\n            if os.path.exists(temp_file):\n                os.remove(temp_file)\n\n\nclass TestDeleteAllTasks:\n    """\n    Unit tests for delete_all method in TaskRepository.\n    \n    Tests the bulk deletion functionality that removes all tasks\n    and persists the empty state.\n    """\n    \n    def test_delete_all_returns_count_of_deleted_tasks(self):\n        """Test that delete_all returns the correct count of deleted tasks."""\n        with tempfile.NamedTemporaryFile(mode='w', delete=False, suffix='.json') as f:\n            temp_file = f.name\n        \n        try:\n            repo = TaskRepository(data_file=temp_file)\n            \n            # Create multiple tasks\n            repo.create(TaskCreate(title="Task 1", description="Description 1"))\n            repo.create(TaskCreate(title="Task 2", description="Description 2"))\n            repo.create(TaskCreate(title="Task 3", description="Description 3"))\n            \n            # Verify 3 tasks exist\n            assert len(repo.get_all()) == 3\n            \n            # Delete all tasks\n            deleted_count = repo.delete_all()\n            \n            # Verify correct count returned\n            assert deleted_count == 3\n            \n        finally:\n            if os.path.exists(temp_file):\n                os.remove(temp_file)\n    \n    def test_delete_all_empties_task_list(self):\n        """Test that delete_all removes all tasks from storage."""\n        with tempfile.NamedTemporaryFile(mode='w', delete=False, suffix='.json') as f:\n            temp_file = f.name\n        \n        try:\n            repo = TaskRepository(data_file=temp_file)\n            \n            # Create multiple tasks\n            repo.create(TaskCreate(title="Task 1", description="Description 1"))\n            repo.create(TaskCreate(title="Task 2", description="Description 2"))\n            \n            # Delete all tasks\n            repo.delete_all()\n            \n            # Verify task list is empty\n            all_tasks = repo.get_all()\n            assert len(all_tasks) == 0\n            assert all_tasks == []\n            \n        finally:\n            if os.path.exists(temp_file):\n                os.remove(temp_file)\n    \n    def test_delete_all_on_empty_repository_returns_zero(self):\n        """Test that delete_all on empty repository returns 0."""\n        with tempfile.NamedTemporaryFile(mode='w', delete=False, suffix='.json') as f:\n            temp_file = f.name\n        \n        try:\n            repo = TaskRepository(data_file=temp_file)\n            \n            # Verify repository is empty\n            assert len(repo.get_all()) == 0\n            \n            # Delete all (should return 0)\n            deleted_count = repo.delete_all()\n            \n            assert deleted_count == 0\n            \n        finally:\n            if os.path.exists(temp_file):\n                os.remove(temp_file)\n    \n    def test_delete_all_persists_empty_state(self):\n        """Test that delete_all persists the empty state to disk."""\n        with tempfile.NamedTemporaryFile(mode='w', delete=False, suffix='.json') as f:\n            temp_file = f.name\n        \n        try:\n            # Create repository and add tasks\n            repo1 = TaskRepository(data_file=temp_file)\n            repo1.create(TaskCreate(title="Task 1", description="Description 1"))\n            repo1.create(TaskCreate(title="Task 2", description="Description 2"))\n            \n            # Delete all tasks\n            repo1.delete_all()\n            \n            # Create new repository instance (simulates restart)\n            repo2 = TaskRepository(data_file=temp_file)\n            \n            # Verify tasks are still gone after restart\n            all_tasks = repo2.get_all()\n            assert len(all_tasks) == 0\n            \n        finally:\n            if os.path.exists(temp_file):\n                os.remove(temp_file)\n    \n    @settings(max_examples=50)\n    @given(tasks_data=st.lists(task_create_strategy(), min_size=1, max_size=20))\n    def test_property_delete_all_removes_all_tasks(self, tasks_data):\n        """\n        Property: For any set of tasks in the repository, calling delete_all\n        should result in an empty repository and return the count of deleted tasks.\n        """\n        with tempfile.NamedTemporaryFile(mode='w', delete=False, suffix='.json') as f:\n            temp_file = f.name\n        \n        try:\n            repo = TaskRepository(data_file=temp_file)\n            \n            # Create all tasks\n            for task_data in tasks_data:\n                repo.create(task_data)\n            \n            # Get count before deletion\n            initial_count = len(repo.get_all())\n            \n            # Delete all tasks\n            deleted_count = repo.delete_all()\n            \n            # Verify all tasks were deleted\n            assert deleted_count == initial_count\n            assert len(repo.get_all()) == 0\n            \n        finally:\n            if os.path.exists(temp_file):\n                os.remove(temp_file)\n